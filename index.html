<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linear Algebra JS Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/13.1.1/math.min.js"></script>
</head>
<body>
    <h1>Linear Algebra JS Example</h1>

    <!-- Input element to select multiple JPEG files -->
    <input type="file" id="imageInput" accept="image/jpeg" multiple>

    <!-- Container to display matrices -->
    <div id="matrixContainer"></div>

    <script>

        // Function to convert File object to RGB matrices
        function fileObjectToImageRgb(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();

                // Load the image from the File object
                reader.onload = function(e) {
                    img.src = e.target.result;
                };

                img.onload = function() {
                    try {
                        // Create a canvas to draw the image
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        context.drawImage(img, 0, 0);

                        // Get image data from the canvas
                        const imageData = context.getImageData(0, 0, img.width, img.height);
                        const data = imageData.data; // Pixel data array

                        const width = img.width;
                        const height = img.height;

                        // Initialize arrays for R, G, B channels
                        const R = [];
                        const G = [];
                        const B = [];

                        for (let y = 0; y < height; y++) {
                            const rowR = [];
                            const rowG = [];
                            const rowB = [];
                            for (let x = 0; x < width; x++) {
                                const index = (y * width + x) * 4;
                                rowR.push(data[index]);     // Red channel
                                rowG.push(data[index + 1]); // Green channel
                                rowB.push(data[index + 2]); // Blue channel
                            }
                            R.push(rowR);
                            G.push(rowG);
                            B.push(rowB);
                        }

                        // Convert arrays to Matrix instances
                        const RMatrix = math.matrix(R);
                        const GMatrix = math.matrix(G);
                        const BMatrix = math.matrix(B);

                        resolve([RMatrix, GMatrix, BMatrix]);
                    } catch (error) {
                        alert('An error occurred while processing the image: ' + error.message);
                        reject(error);
                    }
                };

                img.onerror = function() {
                    const errorMessage = 'Error loading image ' + file.name;
                    alert(errorMessage);
                    reject(new Error(errorMessage));
                };

                // Read the file as a Data URL
                reader.onerror = function() {
                    const errorMessage = 'Error reading file ' + file.name;
                    alert(errorMessage);
                    reject(new Error(errorMessage));
                };

                reader.readAsDataURL(file);
            });
        }

        // Function to display matrices on the page
        function displayMatrices(fileName, R, G, B) {
            const container = document.getElementById('matrixContainer');

            // Create elements to display the matrices
            const imageTitle = document.createElement('h2');
            imageTitle.textContent = 'Image: ' + fileName;

            const rTitle = document.createElement('h3');
            rTitle.textContent = 'R Matrix:';

            const rMatrixPre = document.createElement('pre');
            rMatrixPre.textContent = R.toString();

            const gTitle = document.createElement('h3');
            gTitle.textContent = 'G Matrix:';

            const gMatrixPre = document.createElement('pre');
            gMatrixPre.textContent = G.toString();

            const bTitle = document.createElement('h3');
            bTitle.textContent = 'B Matrix:';

            const bMatrixPre = document.createElement('pre');
            bMatrixPre.textContent = B.toString();

            // Append elements to the container
            container.appendChild(imageTitle);
            container.appendChild(rTitle);
            container.appendChild(rMatrixPre);
            container.appendChild(gTitle);
            container.appendChild(gMatrixPre);
            container.appendChild(bTitle);
            container.appendChild(bMatrixPre);
        }

        // Event listener for file input changes
        document.getElementById('imageInput').addEventListener('change', function(event) {
            const files = event.target.files;

            // Clear previous matrices
            const container = document.getElementById('matrixContainer');
            container.innerHTML = '';

            // Iterate over selected files
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                fileObjectToImageRgb(file)
                    .then(function([R, G, B]) {
                        // Display the matrices on the page
                        displayMatrices(file.name, R, G, B);
                    })
                    .catch(function(error) {
                        // Exception is re-thrown after alert
                        throw error;
                    });
            }
        });
    </script>
</body>
</html>
